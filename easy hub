local DrRayLibrary = loadstring(game:HttpGet("https://raw.githubusercontent.com/AZYsGithub/DrRay-UI-Library/main/DrRay.lua"))()
local window = DrRayLibrary:Load("easy hub", "Default")

local tab = DrRayLibrary.newTab("เมนู", "ImageIdHere")

local distanceOptions = {
    ["1,000"] = 1000,
    ["2,000"] = 2000,
    ["3,000"] = 3000,
    ["4,000"] = 4000,
    ["5,000"] = 5000,
    ["75.00"] = 75
}

_G.maxAttackDistance = 1000

tab.newDropdown("เลือกระยะการโจมตี", "เลือกระยะห่างที่ต้องการ", {"1,000", "2,000", "3,000", "4,000", "5,000", "75.00"}, function(selected)
    _G.maxAttackDistance = distanceOptions[selected]
end)

-- ตัวเปิด/ปิดโจมตีระบบเดิม
tab.newToggle("เปิด ฟาร์มอัตโนมัติ", "เปิดเพื่อใช้ฟังก์ชั่น Auto Attack เดิม", true, function(toggleState)
    if toggleState then
        _G.a = true
    else
        _G.a = false
    end

    function attack(name)
        local args = {
            [1] = {
                [1] = {
                    ["Event"] = "PunchAttack",
                    ["Enemy"] = name
                },
                [2] = "\4"
            }
        }
        game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
    end

    function getNextEnemy(excludedEnemies, maxDistance)
        local closestEnemy = nil
        local closestDistance = math.huge

        for i, v in pairs(workspace.__Main.__Enemies.Client:GetChildren()) do
            if v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("HealthBar") then
                if not table.find(excludedEnemies, v.Name) then
                    local distance = (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                    if distance < closestDistance and distance <= maxDistance then
                        closestEnemy = v
                        closestDistance = distance
                    end
                end
            end
        end
        return closestEnemy
    end

    local attackedEnemies = {}

    while _G.a do
        local currentEnemy = getNextEnemy(attackedEnemies, _G.maxAttackDistance)

        if currentEnemy then
            repeat
                wait(0.1)
                game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = currentEnemy.HumanoidRootPart.CFrame * CFrame.new(0, 0, 4)
                attack(currentEnemy.Name)

                local healthText = currentEnemy.HealthBar.Main.Bar.Amount.Text
                local healthValue = tonumber(healthText:match("(%d+)"))

                if healthValue == nil or healthValue <= 0 then
                    table.insert(attackedEnemies, currentEnemy.Name)
                    currentEnemy = nil
                    break
                end
            until healthValue == nil or healthValue <= 0 or not _G.a

            if currentEnemy == nil then
                currentEnemy = getNextEnemy(attackedEnemies, _G.maxAttackDistance)
                if not currentEnemy then
                    attackedEnemies = {}
                end
            end
        else
            wait(1)
        end
    end
end)

-- ////////////////////// เพิ่ม Auto Attack V2 //////////////////////

local player = game.Players.LocalPlayer
local enemiesFolder = game.Workspace.__Main.__Enemies.Client

local function createAutoAttackV2()
    local closestDistance = math.huge
    local closestNPC = nil
    local runCount = 0
    local currentNPC = nil
    local loopCount = 0

    local function getDistanceToNPC(npc)
        if npc and npc:FindFirstChild("HumanoidRootPart") then
            local npcPosition = npc.HumanoidRootPart.Position
            return (player.Character.HumanoidRootPart.Position - npcPosition).Magnitude
        end
        return math.huge
    end

    local function findClosestNPC()
        closestDistance = math.huge
        closestNPC = nil
        for _, npc in pairs(enemiesFolder:GetChildren()) do
            if npc:IsA("Model") and npc:FindFirstChild("HumanoidRootPart") then
                local distance = getDistanceToNPC(npc)
                if distance < closestDistance then
                    closestDistance = distance
                    closestNPC = npc
                end
            end
        end
    end

    local function attackClosestNPC()
        if closestNPC then
            local npcName = closestNPC.Name
            local args = {
                [1] = {
                    [1] = {
                        ["PetPos"] = {
                            [npcName] = closestNPC.HumanoidRootPart.Position
                        },
                        ["Event"] = "Attack",
                        ["Enemy"] = npcName
                    },
                    [2] = "\8"
                }
            }
            game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
        end
    end

    local function isNPCChanged()
        return currentNPC ~= closestNPC
    end

    while _G.autoAttackV2 do
        findClosestNPC()

        if isNPCChanged() then
            currentNPC = closestNPC
            runCount = 0
        end

        if closestNPC then
            attackClosestNPC()
        end

        wait(1)
    end
end

tab.newToggle(" ให้เงาไปโจมตีศัตรูอัตโนมัติ", "เปิด/ปิด โหมดโจมตีอัตโนมัติแบบใหม่", false, function(state)
    if state then
        _G.autoAttackV2 = true
        createAutoAttackV2()
    else
        _G.autoAttackV2 = false
    end
end)

-- ////////////////////// ฟังก์ชั่นการเก็บ NPC //////////////////////
local tab2 = DrRayLibrary.newTab("เก็บnpc", "เลือกเพื่อให้มันเก็บNPC")

local function findNearestEnemy()
    local nearestEnemy = nil
    local shortestDistance = math.huge

    for _, enemy in pairs(workspace.__Main.__Enemies.Client:GetChildren()) do
        if enemy:IsA("Model") and enemy:FindFirstChild("HumanoidRootPart") then
            local distance = (enemy.HumanoidRootPart.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                nearestEnemy = enemy
            end
        end
    end

    return nearestEnemy
end

local isLooping = false

local function loopFindNearestEnemy()
    while isLooping do
        local nearestEnemy = findNearestEnemy()

        if nearestEnemy then
            local args = {
                [1] = {
                    [1] = {
                        ["Event"] = "EnemyCapture",
                        ["Enemy"] = nearestEnemy.Name
                    },
                    [2] = "\4"
                }
            }

            game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
        end

        wait(0)
    end
end

tab2.newToggle("เปิด/ปิด เก็บ NPC", "เปิดเพื่อเริ่มเก็บ NPC อัตโนมัติ", false, function(state)
    isLooping = state
    if state then
        spawn(function() loopFindNearestEnemy() end)
    else
        isLooping = false
    end
end)

-- ตัวแปรควบคุมการวนลูป
local isLooping = true 

local function loopFindNearestEnemy()
    while isLooping do
        local nearestEnemy = findNearestEnemy()

        if nearestEnemy then
            local args = {
                [1] = {
                    [1] = {
                        ["Event"] = "EnemyDestroy",
                        ["Enemy"] = nearestEnemy.Name
                    },
                    [2] = "\4"
                }
            }

            game:GetService("ReplicatedStorage"):WaitForChild("BridgeNet2"):WaitForChild("dataRemoteEvent"):FireServer(unpack(args))
        end

        wait(0)
    end
end

tab2.newToggle("เปิด/ปิด เก็บแบบเพชร", "เปิดเพื่อเริ่มเก็บ NPC อัตโนมัติ", false, function(state)
    isLooping = state
    if state then
        spawn(function()
            loopFindNearestEnemy()
        end)
    else
        isLooping = false
    end
end)
